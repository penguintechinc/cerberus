# Cerberus NGFW - Fluent Bit Configuration
# Ships logs from all components to OpenSearch

[SERVICE]
    Flush         5
    Daemon        Off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Health_Check  On

# ============================================================================
# INPUT: Suricata EVE JSON Logs (IPS)
# ============================================================================
[INPUT]
    Name              tail
    Tag               cerberus.ips.*
    Path              /var/log/suricata/eve.json
    Parser            json
    DB                /fluent-bit/db/suricata-ips.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  5

# ============================================================================
# INPUT: Suricata IDS Batch Logs
# ============================================================================
[INPUT]
    Name              tail
    Tag               cerberus.ids.*
    Path              /var/log/suricata-ids/eve.json
    Parser            json
    DB                /fluent-bit/db/suricata-ids.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10

# ============================================================================
# INPUT: Zeek Logs
# ============================================================================
[INPUT]
    Name              tail
    Tag               cerberus.zeek.conn
    Path              /var/log/zeek/current/conn.log
    Parser            zeek_tsv
    DB                /fluent-bit/db/zeek-conn.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10

[INPUT]
    Name              tail
    Tag               cerberus.zeek.dns
    Path              /var/log/zeek/current/dns.log
    Parser            zeek_tsv
    DB                /fluent-bit/db/zeek-dns.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10

[INPUT]
    Name              tail
    Tag               cerberus.zeek.http
    Path              /var/log/zeek/current/http.log
    Parser            zeek_tsv
    DB                /fluent-bit/db/zeek-http.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10

[INPUT]
    Name              tail
    Tag               cerberus.zeek.ssl
    Path              /var/log/zeek/current/ssl.log
    Parser            zeek_tsv
    DB                /fluent-bit/db/zeek-ssl.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10

# ============================================================================
# INPUT: VPN Logs
# ============================================================================
[INPUT]
    Name              tail
    Tag               cerberus.vpn.wireguard
    Path              /var/log/wireguard/*.log
    Parser            syslog
    DB                /fluent-bit/db/wireguard.db
    Mem_Buf_Limit     10MB
    Refresh_Interval  10

[INPUT]
    Name              tail
    Tag               cerberus.vpn.ipsec
    Path              /var/log/charon.log
    Parser            syslog
    DB                /fluent-bit/db/ipsec.db
    Mem_Buf_Limit     10MB
    Refresh_Interval  10

[INPUT]
    Name              tail
    Tag               cerberus.vpn.openvpn
    Path              /var/log/openvpn/*.log
    Parser            syslog
    DB                /fluent-bit/db/openvpn.db
    Mem_Buf_Limit     10MB
    Refresh_Interval  10

# ============================================================================
# INPUT: Content Filter Logs
# ============================================================================
[INPUT]
    Name              tail
    Tag               cerberus.filter.*
    Path              /var/log/cerberus-filter/*.json
    Parser            json
    DB                /fluent-bit/db/filter.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  5

# ============================================================================
# INPUT: Cerberus API Audit Logs
# ============================================================================
[INPUT]
    Name              tail
    Tag               cerberus.audit.*
    Path              /var/log/cerberus-api/audit.json
    Parser            json
    DB                /fluent-bit/db/audit.db
    Mem_Buf_Limit     10MB
    Refresh_Interval  5

# ============================================================================
# INPUT: MarchProxy Logs
# ============================================================================
[INPUT]
    Name              tail
    Tag               marchproxy.nlb.*
    Path              /var/log/marchproxy/nlb/*.log
    Parser            json
    DB                /fluent-bit/db/marchproxy-nlb.db
    Mem_Buf_Limit     50MB
    Refresh_Interval  5

[INPUT]
    Name              tail
    Tag               marchproxy.alb.*
    Path              /var/log/marchproxy/alb/*.log
    Parser            json
    DB                /fluent-bit/db/marchproxy-alb.db
    Mem_Buf_Limit     50MB
    Refresh_Interval  5

# ============================================================================
# FILTER: Add metadata
# ============================================================================
[FILTER]
    Name          record_modifier
    Match         cerberus.*
    Record        cluster cerberus
    Record        environment ${ENVIRONMENT:-production}

[FILTER]
    Name          record_modifier
    Match         marchproxy.*
    Record        cluster cerberus
    Record        component marchproxy
    Record        environment ${ENVIRONMENT:-production}

# ============================================================================
# FILTER: Nest Suricata alert fields
# ============================================================================
[FILTER]
    Name          nest
    Match         cerberus.ips.*
    Operation     nest
    Wildcard      alert.*
    Nest_under    alert_details

# ============================================================================
# OUTPUT: OpenSearch - IPS Alerts
# ============================================================================
[OUTPUT]
    Name            opensearch
    Match           cerberus.ips.*
    Host            ${OPENSEARCH_HOST:-opensearch}
    Port            ${OPENSEARCH_PORT:-9200}
    HTTP_User       ${OPENSEARCH_USER:-admin}
    HTTP_Passwd     ${OPENSEARCH_PASSWORD:-Cerberus@123}
    Index           cerberus-ips
    Type            _doc
    Suppress_Type_Name On
    tls             On
    tls.verify      Off
    Retry_Limit     5
    Buffer_Size     5MB
    Trace_Error     On

# ============================================================================
# OUTPUT: OpenSearch - IDS Batch Alerts
# ============================================================================
[OUTPUT]
    Name            opensearch
    Match           cerberus.ids.*
    Host            ${OPENSEARCH_HOST:-opensearch}
    Port            ${OPENSEARCH_PORT:-9200}
    HTTP_User       ${OPENSEARCH_USER:-admin}
    HTTP_Passwd     ${OPENSEARCH_PASSWORD:-Cerberus@123}
    Index           cerberus-ids
    Type            _doc
    Suppress_Type_Name On
    tls             On
    tls.verify      Off
    Retry_Limit     5
    Buffer_Size     5MB

# ============================================================================
# OUTPUT: OpenSearch - Zeek Logs
# ============================================================================
[OUTPUT]
    Name            opensearch
    Match           cerberus.zeek.*
    Host            ${OPENSEARCH_HOST:-opensearch}
    Port            ${OPENSEARCH_PORT:-9200}
    HTTP_User       ${OPENSEARCH_USER:-admin}
    HTTP_Passwd     ${OPENSEARCH_PASSWORD:-Cerberus@123}
    Index           cerberus-zeek
    Type            _doc
    Suppress_Type_Name On
    tls             On
    tls.verify      Off
    Retry_Limit     5
    Buffer_Size     5MB

# ============================================================================
# OUTPUT: OpenSearch - VPN Logs
# ============================================================================
[OUTPUT]
    Name            opensearch
    Match           cerberus.vpn.*
    Host            ${OPENSEARCH_HOST:-opensearch}
    Port            ${OPENSEARCH_PORT:-9200}
    HTTP_User       ${OPENSEARCH_USER:-admin}
    HTTP_Passwd     ${OPENSEARCH_PASSWORD:-Cerberus@123}
    Index           cerberus-vpn
    Type            _doc
    Suppress_Type_Name On
    tls             On
    tls.verify      Off
    Retry_Limit     5
    Buffer_Size     2MB

# ============================================================================
# OUTPUT: OpenSearch - Content Filter Logs
# ============================================================================
[OUTPUT]
    Name            opensearch
    Match           cerberus.filter.*
    Host            ${OPENSEARCH_HOST:-opensearch}
    Port            ${OPENSEARCH_PORT:-9200}
    HTTP_User       ${OPENSEARCH_USER:-admin}
    HTTP_Passwd     ${OPENSEARCH_PASSWORD:-Cerberus@123}
    Index           cerberus-filter
    Type            _doc
    Suppress_Type_Name On
    tls             On
    tls.verify      Off
    Retry_Limit     5
    Buffer_Size     5MB

# ============================================================================
# OUTPUT: OpenSearch - Audit Logs
# ============================================================================
[OUTPUT]
    Name            opensearch
    Match           cerberus.audit.*
    Host            ${OPENSEARCH_HOST:-opensearch}
    Port            ${OPENSEARCH_PORT:-9200}
    HTTP_User       ${OPENSEARCH_USER:-admin}
    HTTP_Passwd     ${OPENSEARCH_PASSWORD:-Cerberus@123}
    Index           cerberus-audit
    Type            _doc
    Suppress_Type_Name On
    tls             On
    tls.verify      Off
    Retry_Limit     5
    Buffer_Size     2MB

# ============================================================================
# OUTPUT: OpenSearch - MarchProxy Logs
# ============================================================================
[OUTPUT]
    Name            opensearch
    Match           marchproxy.*
    Host            ${OPENSEARCH_HOST:-opensearch}
    Port            ${OPENSEARCH_PORT:-9200}
    HTTP_User       ${OPENSEARCH_USER:-admin}
    HTTP_Passwd     ${OPENSEARCH_PASSWORD:-Cerberus@123}
    Index           marchproxy
    Type            _doc
    Suppress_Type_Name On
    tls             On
    tls.verify      Off
    Retry_Limit     5
    Buffer_Size     5MB

# ============================================================================
# OUTPUT: Stdout for debugging (optional)
# ============================================================================
[OUTPUT]
    Name            stdout
    Match           *
    Format          json_lines
