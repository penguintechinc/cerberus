---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ipsec-config
  namespace: cerberus-vpn
data:
  ipsec.conf: |
    config setup
      charondebug="all"
      uniqueids=yes
      strictcrlpolicy=no

    conn %default
      ikeversion=ikev2
      authby=secret
      left=%any
      leftsubnet=0.0.0.0/0
      right=%any
      rightsubnet=10.0.1.0/24
      ike=chacha20poly1305-sha512-curve25519!
      esp=chacha20poly1305-sha512!
      keyingtries=1
      dpdaction=clear
      dpddelay=300s
      dpdtimeout=600s

    conn ikev2-vpn
      keyexchange=ikev2
      left=0.0.0.0
      leftid=@vpn.example.com
      right=%any
      rightid=%any
      rightauth=eap-mschapv2
      rightsourceip=10.0.1.0/24
      auto=add

  ipsec.secrets: |
    # RSA private key
    : RSA privkey.pem
    # Pre-shared key
    vpn.example.com : PSK "your-preshared-key-here"
    # EAP credentials
    user1 : EAP "password123"

  charon.conf: |
    charon {
      load_cancel = yes
      multiple_authentication = yes
      cache_crls = yes
      crypto_test {
        on_load = yes
      }
      plugins {
        include_dir = /etc/strongswan/plugins
      }
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ipsec-strongswan
  namespace: cerberus-vpn
  labels:
    app: ipsec
    component: vpn
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: ipsec
  template:
    metadata:
      labels:
        app: ipsec
        component: vpn
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
    spec:
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      hostNetwork: true
      hostPID: false
      hostIPC: false

      securityContext:
        privileged: true
        runAsNonRoot: false
        fsGroup: 0

      containers:
      - name: strongswan
        image: strongswan/strongswan:latest
        imagePullPolicy: IfNotPresent

        securityContext:
          privileged: true
          capabilities:
            add:
            - NET_ADMIN
            - NET_RAW
            - SYS_MODULE
            - SYS_ADMIN
          allowPrivilegeEscalation: true
          readOnlyRootFilesystem: false

        ports:
        - name: ipsec-ike
          containerPort: 500
          protocol: UDP
          hostPort: 500
        - name: ipsec-nat-t
          containerPort: 4500
          protocol: UDP
          hostPort: 4500

        env:
        - name: VIRTUAL_IP
          value: "10.0.1.0/24"
        - name: VPN_DOMAIN
          value: "vpn.example.com"

        volumeMounts:
        - name: ipsec-config
          mountPath: /etc/ipsec.conf
          subPath: ipsec.conf
          readOnly: false
        - name: ipsec-config
          mountPath: /etc/ipsec.secrets
          subPath: ipsec.secrets
          readOnly: false
        - name: ipsec-config
          mountPath: /etc/strongswan.conf
          subPath: charon.conf
          readOnly: false
        - name: ipsec-lib
          mountPath: /var/lib/strongswan
          readOnly: false
        - name: ipsec-run
          mountPath: /var/run
          readOnly: false
        - name: host-proc
          mountPath: /host/proc
          readOnly: true
        - name: host-sys
          mountPath: /host/sys
          readOnly: true

        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 2000m
            memory: 1Gi

        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - ipsec status | grep -q 'ikev2-vpn' && echo "ok" || exit 1
          initialDelaySeconds: 15
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - ipsec status | grep -q 'ikev2-vpn' && echo "ok" || exit 1
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 2

      volumes:
      - name: ipsec-config
        configMap:
          name: ipsec-config
          defaultMode: 0600
      - name: ipsec-lib
        emptyDir: {}
      - name: ipsec-run
        emptyDir: {}
      - name: host-proc
        hostPath:
          path: /proc
      - name: host-sys
        hostPath:
          path: /sys

---
apiVersion: v1
kind: Service
metadata:
  name: ipsec
  namespace: cerberus-vpn
  labels:
    app: ipsec
    component: vpn
spec:
  type: LoadBalancer
  selector:
    app: ipsec
  ports:
  - name: ipsec-ike
    port: 500
    targetPort: 500
    protocol: UDP
  - name: ipsec-nat-t
    port: 4500
    targetPort: 4500
    protocol: UDP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600

---
apiVersion: v1
kind: Service
metadata:
  name: ipsec-internal
  namespace: cerberus-vpn
  labels:
    app: ipsec
    component: vpn
spec:
  type: ClusterIP
  selector:
    app: ipsec
  ports:
  - name: ipsec-ike
    port: 500
    targetPort: 500
    protocol: UDP
  - name: ipsec-nat-t
    port: 4500
    targetPort: 4500
    protocol: UDP
